name: Windows Build (Stellarium Plugin)

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      stellarium_target:
        description: "Key from ci/stellarium-compat.yml targets (e.g. 25.3-qt6-win64)"
        required: false
        default: ""

jobs:
  build-windows:
    runs-on: windows-latest

    env:
      CMAKE_BUILD_TYPE: Release
      BUILD_DIR: build-windows

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Install PyYAML
        shell: bash
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyyaml

      - name: Resolve Stellarium/Qt/MSVC target from compat file
        shell: bash
        env:
          REQUESTED_TARGET: ${{ github.event.inputs.stellarium_target }}
        run: |
          python ci/resolve_stellarium_compat.py

      - name: Install Ninja
        run: |
          choco install ninja --yes
        shell: powershell

      - name: Install Qt for Windows (desktop)
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          host: windows
          target: desktop
          arch: win64_msvc2022_64
          cache: true
          set-env: true

      - name: Checkout Stellarium Source
        uses: actions/checkout@v4
        with:
          repository: stellarium/stellarium
          ref: v${{ env.STELLARIUM_VERSION }}
          path: stellarium-source
          fetch-depth: 1

      - name: Debug Environment
        run: |
          echo "Qt6_DIR: $env:Qt6_DIR"
          dir env:
        shell: powershell

      - name: Configure CMake (Windows)
        run: |
          cmake -S . -B %BUILD_DIR% ^
            -G "Ninja" ^
            -DCMAKE_BUILD_TYPE=%CMAKE_BUILD_TYPE% ^
            -DCMAKE_PREFIX_PATH="%QT_ROOT_DIR%" ^
            -DSTELROOT="stellarium-source"
        shell: cmd

      - name: Build plugin (Windows Release)
        run: |
          cmake --build %BUILD_DIR% --config %CMAKE_BUILD_TYPE%
        shell: cmd

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-plugin-${{ env.STELLARIUM_TARGET }}-${{ env.CMAKE_BUILD_TYPE }}
          path: |
            ${{ env.BUILD_DIR }}/
          if-no-files-found: warn
