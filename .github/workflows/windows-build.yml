name: Windows Build (Stellarium Plugin)

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      stellarium_target:
        description: "Key from ci/stellarium-compat.yml targets (e.g. 25.3-qt6-win64)"
        required: false
        default: ""

jobs:
  build-windows:
    runs-on: windows-latest

    env:
      CMAKE_BUILD_TYPE: Release
      BUILD_DIR: build-windows

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Install PyYAML
        shell: bash
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyyaml

      - name: Resolve Stellarium/Qt/MSVC target from compat file
        shell: bash
        env:
          REQUESTED_TARGET: ${{ github.event.inputs.stellarium_target }}
        run: |
          compat_path="ci/stellarium-compat.yml"
          if [ ! -f "$compat_path" ]; then
            echo "Compatibility file '$compat_path' not found." >&2
            exit 1
          fi

          python - << 'PYCODE'
          import os, sys, yaml

          compat_path = "ci/stellarium-compat.yml"

          try:
              with open(compat_path, "r", encoding="utf-8") as f:
                  config = yaml.safe_load(f)
          except FileNotFoundError:
              print(f"Compatibility file '{compat_path}' not found.", file=sys.stderr)
              sys.exit(1)

          requested = os.getenv("REQUESTED_TARGET", "").strip()

          target_key = requested or config.get("default")
          if not target_key:
              print("No default target defined in compatibility file and no target requested.", file=sys.stderr)
              sys.exit(1)

          targets = config.get("targets", {}) or {}

          if target_key not in targets:
              print(f"Requested Stellarium target '{target_key}' not found in {compat_path}.", file=sys.stderr)
              print("Available targets: " + ", ".join(sorted(targets.keys())), file=sys.stderr)
              sys.exit(1)

          target = targets[target_key]

          qt = target.get("qt", {}) or {}
          msvc = target.get("msvc", {}) or {}

          def write_env(key, value):
              with open(os.environ["GITHUB_ENV"], "a", encoding="utf-8") as env:
                  env.write(f"{key}={value}\n")

          write_env("STELLARIUM_TARGET", target_key)
          write_env("STELLARIUM_VERSION", target.get("stellarium_version", ""))
          write_env("QT_MAJOR", qt.get("major", ""))
          write_env("QT_VERSION", qt.get("version", ""))
          write_env("MSVC_YEAR", msvc.get("year", ""))
          write_env("MSVC_TOOLSET", msvc.get("toolset", ""))

          print(
              f"Using Stellarium target: {target_key} "
              f"(Stellarium {target.get('stellarium_version')}, "
              f"Qt {qt.get('version')}, MSVC {msvc.get('year')})"
          )
PYCODE

      - name: Install Ninja
        run: |
          choco install ninja --yes
        shell: powershell

      - name: Install Qt for Windows (desktop)
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          host: windows
          target: desktop
          arch: win64_msvc2022_64
          cache: true

      - name: Configure CMake (Windows)
        run: |
          cmake -S . -B $env:BUILD_DIR ^
            -G "Ninja" ^
            -DCMAKE_BUILD_TYPE=$env:CMAKE_BUILD_TYPE ^
            -DCMAKE_PREFIX_PATH="$env:Qt6_DIR"
        shell: cmd

      - name: Build plugin (Windows Release)
        run: |
          cmake --build %BUILD_DIR% --config %CMAKE_BUILD_TYPE%
        shell: cmd

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-plugin-${{ env.STELLARIUM_TARGET }}-${{ env.CMAKE_BUILD_TYPE }}
          path: |
            ${{ env.BUILD_DIR }}/
          if-no-files-found: warn
